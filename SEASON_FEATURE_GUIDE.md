# ğŸ¯ Há»‡ Thá»‘ng MÃ¹a Giáº£i (Season) - Lumina TOEIC

## ğŸ“‹ Tá»•ng Quan

Chá»©c nÄƒng **MÃ¹a Giáº£i (Season)** Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ táº¡o ra chu ká»³ cáº¡nh tranh cÃ³ giá»›i háº¡n thá»i gian, thÃºc Ä‘áº©y Ä‘á»™ng lá»±c há»c táº­p vÃ  tÆ°Æ¡ng tÃ¡c cá»§a ngÆ°á»i dÃ¹ng thÃ´ng qua yáº¿u tá»‘ **Gamification**.

## ğŸ¯ Má»¥c ÄÃ­ch ChÃ­nh

### 1. Duy TrÃ¬ Sá»± Gáº¯n Káº¿t & Äá»™ng Lá»±c
- Táº¡o cuá»™c Ä‘ua má»›i máº» vÃ  liÃªn tá»¥c
- NgÆ°á»i dÃ¹ng cÃ³ Ä‘á»™ng lá»±c há»c táº­p thÆ°á»ng xuyÃªn
- Khuyáº¿n khÃ­ch cáº¡nh tranh lÃ nh máº¡nh

### 2. TÄƒng TÃ­nh CÃ´ng Báº±ng (Fairness)
- Reset Ä‘iá»ƒm sá»‘ sau má»—i mÃ¹a
- NgÆ°á»i dÃ¹ng má»›i cÃ³ cÆ¡ há»™i cáº¡nh tranh sÃ²ng pháº³ng
- NgÄƒn cháº·n tÃ¬nh tráº¡ng thá»‘ng trá»‹ vÄ©nh viá»…n

### 3. CÆ¡ Há»™i Trao ThÆ°á»Ÿng
- Trao thÆ°á»Ÿng cho top user má»—i mÃ¹a
- Khuyáº¿n khÃ­ch nÃ¢ng cáº¥p gÃ³i Pro
- TÄƒng tham gia tÃ­ch cá»±c

## ğŸ”„ CÆ¡ Cháº¿ Hoáº¡t Äá»™ng

### Chu Ká»³ Thá»i Gian
- Má»—i mÃ¹a cÃ³ thá»i gian xÃ¡c Ä‘á»‹nh (VD: 1 thÃ¡ng, 3 thÃ¡ng)
- CÃ³ ngÃ y báº¯t Ä‘áº§u vÃ  káº¿t thÃºc rÃµ rÃ ng
- Tá»± Ä‘á»™ng kÃ­ch hoáº¡t vÃ  káº¿t thÃºc

### Tráº¡ng ThÃ¡i MÃ¹a Giáº£i
- **Upcoming**: Sáº¯p diá»…n ra
- **Active**: Äang diá»…n ra
- **Ended**: ÄÃ£ káº¿t thÃºc

## ğŸ“Š Há»‡ Thá»‘ng TÃ­nh Äiá»ƒm TOEIC (0-990)

### Quy Cháº¿ TÃ­nh Äiá»ƒm Má»›i

Äiá»ƒm cÆ¡ báº£n **giáº£m dáº§n** theo trÃ¬nh Ä‘á»™ TOEIC:

| Má»‘c TOEIC | TrÃ¬nh Äá»™ | Äiá»ƒm/CÃ¢u ÄÃºng | Time Bonus | Accuracy Bonus |
|-----------|----------|---------------|------------|----------------|
| 0-200 | **Beginner** (Báº¯t Ä‘áº§u hÃ nh trÃ¬nh) | 15 | 30% | 150% |
| 201-400 | **Elementary** (Äang tiáº¿n bá»™) | 12 | 28% | 120% |
| 401-600 | **Intermediate** (Trung bÃ¬nh) | 8 | 25% | 90% |
| 601-750 | **Upper-Intermediate** (KhÃ¡ tá»‘t) | 5 | 20% | 60% |
| 751-850 | **Advanced** (Sáºµn sÃ ng thi) | 3 | 15% | 40% |
| 851-990 | **Proficient** (Xuáº¥t sáº¯c) | 2 | 10% | 20% |

### CÃ´ng Thá»©c TÃ­nh Äiá»ƒm

```
Total Score = Base Score + Time Bonus + Accuracy Bonus + Difficulty Bonus

Trong Ä‘Ã³:
- Base Score = Correct Answers Ã— Base Points (theo má»‘c TOEIC)
- Time Bonus = Base Score Ã— Time Bonus % (náº¿u lÃ m nhanh < 30 phÃºt)
- Accuracy Bonus = Base Score Ã— Accuracy Bonus % (náº¿u Ä‘á»™ chÃ­nh xÃ¡c â‰¥ 80%)
- Difficulty Bonus = Base Score Ã— (Difficulty Multiplier - 1)
  + Easy: 0.8x
  + Medium: 1.0x
  + Hard: 1.3x
  + Expert: 1.6x
```

### Æ¯á»›c TÃ­nh Äiá»ƒm TOEIC

```
Estimated TOEIC = (Correct Answers / Total Questions) Ã— 990
```

Dá»±a trÃªn 10 bÃ i luyá»‡n táº­p gáº§n nháº¥t trong mÃ¹a giáº£i.

## ğŸ† Báº£ng Xáº¿p Háº¡ng

### ThÃ´ng Tin Hiá»ƒn Thá»‹
- **Rank**: Thá»© háº¡ng
- **User**: TÃªn vÃ  avatar
- **Score**: Äiá»ƒm sá»‘ tÃ­ch lÅ©y
- **Estimated TOEIC**: Äiá»ƒm TOEIC Æ°á»›c tÃ­nh (0-990)
- **TOEIC Level**: TrÃ¬nh Ä‘á»™ (Beginner â†’ Proficient)

### TÃ­nh NÄƒng
- Xem top 100 (hoáº·c tÃ¹y chá»‰nh)
- Xem thá»© háº¡ng cÃ¡ nhÃ¢n
- Xem thá»‘ng kÃª chi tiáº¿t

## ğŸ”” Há»‡ Thá»‘ng ThÃ´ng BÃ¡o

### Loáº¡i ThÃ´ng BÃ¡o

#### 1. ThÃ´ng BÃ¡o Khuyáº¿n KhÃ­ch (0-600 Ä‘iá»ƒm)
- "Báº¡n Ä‘ang tiáº¿n bá»™ tá»‘t!"
- "Tiáº¿p tá»¥c ná»— lá»±c Ä‘á»ƒ Ä‘áº¡t má»‘c Intermediate!"

#### 2. ThÃ´ng BÃ¡o ThÃ nh TÃ­ch (601-850 Ä‘iá»ƒm)
- "ChÃºc má»«ng! Báº¡n Ä‘Ã£ Ä‘áº¡t Upper-Intermediate!"
- "Báº¡n Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ Ä‘i thi TOEIC!"

#### 3. ThÃ´ng BÃ¡o Xuáº¥t Sáº¯c (851-990 Ä‘iá»ƒm)
- "Tuyá»‡t vá»i! Báº¡n Ä‘Ã£ Ä‘áº¡t trÃ¬nh Ä‘á»™ Proficient!"
- "Báº¡n Ä‘Ã£ sáºµn sÃ ng chinh phá»¥c 990 Ä‘iá»ƒm!"

### Khi NÃ o Gá»­i ThÃ´ng BÃ¡o
- Sau má»—i bÃ i luyá»‡n táº­p
- Khi Ä‘áº¡t má»‘c Ä‘iá»ƒm TOEIC má»›i
- Khi thá»© háº¡ng thay Ä‘á»•i Ä‘Ã¡ng ká»ƒ
- Khi mÃ¹a giáº£i sáº¯p káº¿t thÃºc

## ğŸ“¡ API Endpoints

### Quáº£n LÃ½ MÃ¹a Giáº£i

#### 1. Láº¥y MÃ¹a Giáº£i Hiá»‡n Táº¡i
```http
GET /api/leaderboard/current
```

**Response:**
```json
{
  "leaderboardId": 1,
  "seasonName": "Spring 2025",
  "seasonNumber": 1,
  "startDate": "2025-01-01T00:00:00Z",
  "endDate": "2025-03-31T23:59:59Z",
  "isActive": true,
  "status": "Active",
  "totalParticipants": 1250,
  "daysRemaining": 45
}
```

#### 2. Táº¡o MÃ¹a Giáº£i Má»›i (Admin)
```http
POST /api/leaderboard
Authorization: Bearer {token}

{
  "seasonName": "Summer 2025",
  "seasonNumber": 2,
  "startDate": "2025-04-01T00:00:00Z",
  "endDate": "2025-06-30T23:59:59Z",
  "isActive": false
}
```

#### 3. Láº¥y Báº£ng Xáº¿p Háº¡ng
```http
GET /api/leaderboard/{leaderboardId}/ranking?top=100
```

**Response:**
```json
[
  {
    "userId": 123,
    "fullName": "Nguyá»…n VÄƒn A",
    "score": 15840,
    "rank": 1,
    "estimatedTOEICScore": 785,
    "toeicLevel": "Advanced",
    "avatarUrl": "https://..."
  }
]
```

#### 4. Láº¥y Thá»‘ng KÃª CÃ¡ NhÃ¢n
```http
GET /api/leaderboard/user/stats
Authorization: Bearer {token}
```

**Response:**
```json
{
  "userId": 123,
  "currentRank": 15,
  "currentScore": 12500,
  "estimatedTOEICScore": 685,
  "toeicLevel": "Upper-Intermediate",
  "totalAttempts": 45,
  "correctAnswers": 892,
  "accuracyRate": 0.78,
  "isReadyForTOEIC": true
}
```

#### 5. Láº¥y ThÃ´ng Tin TÃ­nh Äiá»ƒm TOEIC
```http
GET /api/leaderboard/user/toeic-calculation
Authorization: Bearer {token}
```

**Response:**
```json
{
  "userId": 123,
  "estimatedTOEICScore": 685,
  "toeicLevel": "Upper-Intermediate",
  "basePointsPerCorrect": 5,
  "timeBonus": 0.20,
  "accuracyBonus": 0.60,
  "difficultyMultiplier": 1.0,
  "totalSeasonScore": 12500
}
```

#### 6. Reset MÃ¹a Giáº£i (Admin)
```http
POST /api/leaderboard/{leaderboardId}/reset?archiveScores=true
Authorization: Bearer {token}
```

#### 7. TÃ­nh Láº¡i Äiá»ƒm (Admin)
```http
POST /api/leaderboard/{leaderboardId}/recalculate
Authorization: Bearer {token}
```

#### 8. Tá»± Äá»™ng Quáº£n LÃ½ MÃ¹a Giáº£i (Admin)
```http
POST /api/leaderboard/auto-manage
Authorization: Bearer {token}
```

Endpoint nÃ y nÃªn Ä‘Æ°á»£c gá»i Ä‘á»‹nh ká»³ bá»Ÿi **Background Job** Ä‘á»ƒ:
- Tá»± Ä‘á»™ng kÃ­ch hoáº¡t mÃ¹a má»›i khi Ä‘áº¿n ngÃ y báº¯t Ä‘áº§u
- Tá»± Ä‘á»™ng káº¿t thÃºc mÃ¹a cÅ© khi háº¿t háº¡n

## ğŸ”§ CÃ i Äáº·t Background Job

### Sá»­ dá»¥ng Hangfire (Khuyáº¿n Nghá»‹)

```csharp
// Program.cs hoáº·c Startup.cs
services.AddHangfire(config => 
    config.UseSqlServerStorage(connectionString));

services.AddHangfireServer();

// Scheduled Job
RecurringJob.AddOrUpdate<ILeaderboardService>(
    "auto-manage-seasons",
    service => service.AutoManageSeasonsAsync(),
    Cron.Hourly // Cháº¡y má»—i giá»
);
```

## ğŸ’¾ Database Schema

### Báº£ng Leaderboard (Season)
```sql
CREATE TABLE Leaderboards (
    LeaderboardId INT PRIMARY KEY IDENTITY,
    SeasonName NVARCHAR(200),
    SeasonNumber INT NOT NULL UNIQUE,
    StartDate DATETIME2,
    EndDate DATETIME2,
    IsActive BIT DEFAULT 0,
    CreateAt DATETIME2 DEFAULT GETUTCDATE(),
    UpdateAt DATETIME2
);
```

### Báº£ng UserLeaderboard (Äiá»ƒm User)
```sql
CREATE TABLE UserLeaderboards (
    UserLeaderboardId INT PRIMARY KEY IDENTITY,
    UserId INT NOT NULL,
    LeaderboardId INT NOT NULL,
    Score INT DEFAULT 0,
    FOREIGN KEY (UserId) REFERENCES Users(UserId),
    FOREIGN KEY (LeaderboardId) REFERENCES Leaderboards(LeaderboardId),
    UNIQUE (UserId, LeaderboardId)
);
```

## ğŸ® Flow Hoáº¡t Äá»™ng

### 1. Khá»Ÿi Táº¡o MÃ¹a Má»›i
```
Admin táº¡o Season má»›i 
â†’ Há»‡ thá»‘ng validate (khÃ´ng trÃ¹ng ngÃ y, sá»‘ mÃ¹a)
â†’ LÆ°u vÃ o database
â†’ Chá» Ä‘áº¿n ngÃ y báº¯t Ä‘áº§u
```

### 2. KÃ­ch Hoáº¡t Tá»± Äá»™ng
```
Background Job cháº¡y má»—i giá»
â†’ Kiá»ƒm tra mÃ¹a cÃ³ StartDate <= now
â†’ Set IsActive = true
â†’ Gá»­i thÃ´ng bÃ¡o cho users
```

### 3. User LÃ m BÃ i
```
User hoÃ n thÃ nh bÃ i táº­p
â†’ TÃ­nh Ä‘iá»ƒm TOEIC Æ°á»›c tÃ­nh (10 bÃ i gáº§n nháº¥t)
â†’ Ãp dá»¥ng cÃ´ng thá»©c tÃ­nh Ä‘iá»ƒm theo má»‘c TOEIC
â†’ Cáº­p nháº­t UserLeaderboard
â†’ Gá»­i thÃ´ng bÃ¡o náº¿u Ä‘áº¡t má»‘c má»›i
```

### 4. Xem Báº£ng Xáº¿p Háº¡ng
```
User/Guest truy cáº­p
â†’ Load tá»« UserLeaderboards
â†’ Sáº¯p xáº¿p theo Score
â†’ Hiá»ƒn thá»‹ vá»›i thÃ´ng tin TOEIC
```

### 5. Káº¿t ThÃºc MÃ¹a
```
Background Job cháº¡y má»—i giá»
â†’ Kiá»ƒm tra mÃ¹a cÃ³ EndDate < now
â†’ Set IsActive = false
â†’ Archive Ä‘iá»ƒm sá»‘ (optional)
â†’ Gá»­i thÃ´ng bÃ¡o káº¿t thÃºc
â†’ Trao thÆ°á»Ÿng top users
```

## ğŸ“ˆ Metrics & Analytics

### Cáº§n Theo DÃµi
- Sá»‘ ngÆ°á»i tham gia má»—i mÃ¹a
- Tá»· lá»‡ hoÃ n thÃ nh bÃ i táº­p
- PhÃ¢n bá»‘ Ä‘iá»ƒm TOEIC
- Tá»· lá»‡ retention giá»¯a cÃ¡c mÃ¹a
- Top performers

### Dashboard Admin
- Tá»•ng sá»‘ mÃ¹a
- MÃ¹a hiá»‡n táº¡i
- Top 10 users
- Biá»ƒu Ä‘á»“ tÄƒng trÆ°á»Ÿng
- Thá»‘ng kÃª theo má»‘c TOEIC

## ğŸš€ Best Practices

### 1. TÃ­nh Äiá»ƒm
- LuÃ´n tÃ­nh tá»« 10 bÃ i gáº§n nháº¥t
- Cache estimated TOEIC Ä‘á»ƒ trÃ¡nh tÃ­nh láº¡i
- Recalculate khi cáº§n thiáº¿t

### 2. Performance
- Index trÃªn (LeaderboardId, Score)
- Pagination cho ranking
- Cache báº£ng xáº¿p háº¡ng (5-10 phÃºt)

### 3. Fairness
- KhÃ´ng cho phÃ©p chá»‰nh sá»­a Ä‘iá»ƒm thá»§ cÃ´ng
- Log má»i thay Ä‘á»•i
- Detect cheating patterns

### 4. UX
- Hiá»ƒn thá»‹ rÃµ ngÃ y káº¿t thÃºc
- Countdown timer
- ThÃ´ng bÃ¡o trÆ°á»›c khi káº¿t thÃºc (3 ngÃ y, 1 ngÃ y, 1 giá»)

## ğŸ” Security

### Authorization
- Admin: CRUD mÃ¹a giáº£i
- User: Xem ranking, stats
- Guest: Xem ranking (public)

### Validation
- KhÃ´ng trÃ¹ng SeasonNumber
- KhÃ´ng trÃ¹ng ngÃ y thÃ¡ng
- StartDate < EndDate
- KhÃ´ng xÃ³a mÃ¹a Ä‘ang active

## ğŸ› Troubleshooting

### Äiá»ƒm khÃ´ng cáº­p nháº­t
1. Kiá»ƒm tra ExamAttempt.Status = "Completed"
2. Kiá»ƒm tra ngÃ y thÃ¡ng attempt náº±m trong season
3. Cháº¡y Recalculate

### MÃ¹a khÃ´ng tá»± Ä‘á»™ng kÃ­ch hoáº¡t
1. Kiá»ƒm tra Background Job cÃ³ cháº¡y khÃ´ng
2. Kiá»ƒm tra StartDate format
3. Kiá»ƒm tra timezone

### Ranking khÃ´ng Ä‘Ãºng
1. Clear cache
2. Recalculate scores
3. Kiá»ƒm tra UserLeaderboards

## ğŸ“š TÃ i Liá»‡u Tham Kháº£o

- [TOEIC Scoring Guide](https://www.ets.org/toeic)
- [Gamification Best Practices](https://www.gamify.com)
- [Leaderboard Design Patterns](https://www.playfab.com)

---

**Version:** 1.0  
**Last Updated:** October 30, 2025  
**Author:** Lumina Development Team
